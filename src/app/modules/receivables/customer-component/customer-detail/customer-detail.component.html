<div class="container-fluid">
    <div class="row no-gutters">
        <div class="visualization-heading col-12">
            <div class="heading-info">
                <div class="row">
                    <div class="col-6">                
                        <h3 class="heading-title">Customer Master</h3>
                    </div>
                    <div class="col-6">
                        <div class="row">
                            <div class="col">
                                <button class="btn-primary text-white btn   btn-sm"  title="New Customer" style="float: right" (click)="goToDetailForm('new','customer')">
                                    <mat-icon>add</mat-icon> New Customer
                                </button>
                            </div>
                           <!--- <div class="col">
                                <button class="btn-danger text-white btn   btn-sm"  title="Search Customer" style="float: right" (click)="searchCustomer()">
                                    <mat-icon>search</mat-icon> Search 
                                </button>
                            </div> -->
                            <div class="col">
                                <button class="btn-info text-white btn   btn-sm"  title="Print Customer Statement of Account" style="float: right" (click)="getCustomerSoa()">
                                    <mat-icon>print</mat-icon> Print SoA
                                </button>
                            </div> 
                            <div class="col">
                                <button class="btn-danger text-white btn   btn-sm"  title="Add Contact" style="float: right" (click)="addContact()">
                                    <mat-icon>person</mat-icon> Add Contact
                                </button>
                            </div>
                            
                            <!--<div class="col">
                                <button class="btn-dark text-white btn   btn-sm"  title="Copy to Contact" style="float: right" (click)="copyToContact()">
                                    <mat-icon>play_for_work</mat-icon> Copy to Contact
                                </button>
                            </div>-->
                            <div class="col">
                                <button *ngIf="!isEditMode" class="btn-warning text-white btn btn-sm" (click)="toggleEdit()">
                                    <mat-icon>edit</mat-icon> Edit Customer
                                </button>

                                <button *ngIf="isEditMode" class="btn-success text-white btn btn-sm" (click)="submitForm()">
                                    <mat-icon>save</mat-icon> Submit Customer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-4">
                        <div class="mb-3">
                            <input type="text" [(ngModel)]="searchText" class="form-control" placeholder="Search customers..." />
                        </div>
                        <table class="table table-hover table-responsive-xxl">
                            <thead class="table-dark">
                                <tr class="table-reflow">
                                    <th>PCODE</th>
                                    <th>CUSTOMER NAME</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let cust of (customerList | filterTable:searchText| slice:0:10); let i = index;">
                                    <td>{{ cust.PCODE }}</td>
                                    <td>{{ cust.CUST_NAME }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" (click)="goToDetailForm(cust.PCODE, 'customer')" title="View Customer Details">
                                            <mat-icon>edit</mat-icon>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-8">
                        <form [formGroup]="custForm" class="form-container">
                            <p>Customer Details</p>
                            <div class="row">
                                <div class="col-2">
                                    <mat-label >Customer Code </mat-label>
                                    <input  matInput class="form-control form-control-sm" #pcode formControlName="pcode"  [readonly]="!isEditMode" >
                                </div>
                                <div class="col-8">
                                    <mat-label >Name</mat-label>
                                    <input formControlName="custName"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                                <div class="col-2">
                                    <mat-label >Active</mat-label>
                                    <mat-select class="form-control form-control-sm" formControlName="custStatus">
                                        <mat-option value="A">True</mat-option>
                                        <mat-option value="I">False</mat-option>
                                    </mat-select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <mat-label>Tax Number</mat-label>
                                    <input formControlName="custTaxNo"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                                <div class="col">
                                    <mat-label>National ID</mat-label>
                                    <input formControlName="custCR"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                                <div class="col">
                                    <mat-label>Branch</mat-label>
                                    <input formControlName="custBranch"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                                <div class="col">
                                    <mat-label>Account Type</mat-label>
                                    <input formControlName="custAccountType"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                                <div class="col">
                                    <mat-label>Account Category</mat-label>
                                    <input formControlName="custAccountCategory"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-3">
                                    <mat-label>Phone 1</mat-label>
                                    <input formControlName="custPhone1"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                                <div class="col-3">
                                    <mat-label>Phone 2</mat-label>
                                    <input formControlName="custPhone2"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                                <div class="col-3">
                                    <mat-label>Mobile</mat-label>
                                    <input formControlName="mobile"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                                <div class="col-3">
                                    <mat-label>Email</mat-label>
                                    <input formControlName="custEmail"  matInput class="form-control form-control-sm"  [readonly]="!isEditMode">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-4">
                                    <mat-label>Address Line 1</mat-label>
                                    <input formControlName="custAdd1"  matInput class="form-control form-control-sm">
                                </div>
                                <div class="col-4">
                                    <mat-label>Address Line 2</mat-label>
                                    <input formControlName="custAdd2"  matInput class="form-control form-control-sm">
                                </div>
                                <div class="col-4">
                                    <mat-label>Address Line 3</mat-label>
                                    <input formControlName="custAdd3"  matInput class="form-control form-control-sm">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-4">
                                    <mat-label>Opening Balance (AED)</mat-label>
                                    <input formControlName="opbal" matInput class="form-control form-control-sm">                                
                                </div>
                                <div class="col-4">
                                    <mat-label>Credit Limit (AED)</mat-label>
                                    <input formControlName="crlimit" matInput class="form-control form-control-sm">                                
                                </div>
                                <div class="col-4">
                                    <mat-label>Credit Period</mat-label>
                                    <input formControlName="crperiod" matInput class="form-control form-control-sm">                                
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <mat-label>Remarks</mat-label>
                                    <input formControlName="remarks"  matInput class="form-control form-control-sm">
                                </div>
                            </div>
                            <hr>
                            <div formArrayName="contacts" class="row">
                                <div class="col-6" *ngFor="let con of contacts.controls; let i = index" [formGroupName]="i">
                                    <mat-card class="bg-secondary">
                                        <mat-card-content>
                                            <div class="row">
                                                <div class="col-8">
                                                    <p>Contact Details</p>
                                                </div>
                                                <div class="col-2">
                                                    <button *ngIf="contactEditIndex !== i" class="btn-warning text-white btn btn-sm" (click)="editContact(i)">
                                                        <mat-icon>edit</mat-icon>
                                                    </button>
                                                    <button *ngIf="contactEditIndex === i" class="btn-success text-white btn btn-sm" (click)="saveContact(i)">
                                                        <mat-icon>save</mat-icon>
                                                    </button>
                                                </div>
                                                <div class="col-2">
                                                    <button class="btn-danger text-white btn btn-sm" style="float: right" type="button" (click)="deleteContact(i)">
                                                        <mat-icon>delete</mat-icon>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-4">
                                                    <mat-label >Contact ID </mat-label>
                                                    <input  matInput class="form-control 
                                                    form-control-sm" formControlName="contactId" [readonly]="contactEditIndex !== i" >
                                                </div>
                                                <div class="col-8">
                                                    <mat-label >Name</mat-label>
                                                    <input formControlName="contactPerson"  matInput class="form-control form-control-sm" [readonly]="contactEditIndex !== i">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-4">
                                                    <mat-label>Address Line 1</mat-label>
                                                    <input formControlName="contactAddress1"  matInput class="form-control form-control-sm" [readonly]="contactEditIndex !== i">
                                                </div>
                                                <div class="col-4">
                                                    <mat-label>Address Line 2</mat-label>
                                                    <input formControlName="contactAddress2"  matInput class="form-control form-control-sm" [readonly]="contactEditIndex !== i">
                                                </div>
                                                <div class="col-4">
                                                    <mat-label>Address Line 3</mat-label>
                                                    <input formControlName="contactAddress3"  matInput class="form-control form-control-sm" [readonly]="contactEditIndex !== i">
                                                </div>
                                            </div>
                                             <div class="row">
                                                <div class="col-6">
                                                    <mat-label>Mobile</mat-label>
                                                    <input formControlName="contactMobile"  matInput class="form-control form-control-sm" [readonly]="contactEditIndex !== i">
                                                </div>
                                                <div class="col-6">
                                                    <mat-label>Email</mat-label>
                                                    <input formControlName="contactEmail"  matInput class="form-control form-control-sm" [readonly]="contactEditIndex !== i">
                                                </div>
                                            </div>
                                        </mat-card-content>
                                    </mat-card>
                                </div>
                            </div>
                        </form>
                    </div>
                </div> 
            </div>
        </div>
    </div>   
</div>
<br>

<ng-template #customerLookupDialog >
    <h3 matDialogTitle>
        <b>Search Customer</b>
    </h3>
    <hr>
    <!-- Search Bar -->
    <div class="row d-flex align-items-center">
        <div class="col-auto">
            <mat-icon>search</mat-icon>
        </div>
        <div class="col">
            <input type="text" style="color: black;" 
                   placeholder="Enter search keyword..." 
                   class="form-control form-control-sm" 
                   #search 
                   (keyup)="quickCustomerSearch(search.value)">
        </div>
    </div>
    <div mat-dialog-content>
        <!-- Table -->
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>PCODE</th>
                    <th>CUSTOMER NAME</th>
                    <th>MOBILE</th>
                    <th>EMAIL</th>
                    <th>ACTIONS</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let cust of CustomerSearchList; let i = index;">
                    <td>{{cust.PCODE}}</td>
                    <td>{{cust.CUST_NAME}}</td>
                    <td>{{cust.MOBILE}}</td>
                    <td>{{cust.EMAIL}}</td>
                    <td>
                        <button mat-raised-button class="bg-warning text-white btn  " (click)="goToDetailForm(cust.PCODE,'customer')">
                            <mat-icon>arrow_forward</mat-icon>                                            
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <hr>
    <br>
</ng-template>

<ng-template #soaLookupDialog>
    <h3 matDialogTitle>
        <b>Statement of Account Preview</b>
    </h3>
    <hr>
    <div mat-dialog-content style="font-size: small;">
        <table class="table table-striped table-sm table-bordered" id="soaTable">
            <thead>
                <tr>
                    <th>Invoice Date</th>
                    <th>Invoice No</th>
                    <th>Reference</th>
                    <th>Description</th>
                    <th>Due Date</th>
                    <!--<th>Amount</th>-->
                    <th>Debit</th>
                    <th>Credit</th>
                    <th>Balance</th>
                    <!--<th>Overdue days</th>-->
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let row of soaData">
                    <td>{{ row.INV_DATE | date:'dd-MM-yyyy' }}</td>
                    <td>{{ row.INV_NO }}</td>
                    <td>{{ row.INV_NO === row.REMARKS ? '' : row.REMARKS }}</td>
                    <td>{{ row.DESCRIPTION }}</td>
                    <td>{{ row.DUEDATE | date:'dd-MM-yyyy' }}</td>
                    <!--<td class="text-end">{{ row.AMOUNT | number:'1.3-3' }}</td>-->
                    <td class="text-end">{{ row.DEBIT | number:'1.3-3' }}</td>
                    <td class="text-end">{{ row.CREDIT | number:'1.3-3' }}</td>
                    <td class="text-end">
                        {{ row.BALANCE < 0 ? '(' + (row.BALANCE | abs | number:'1.3-3') + ')' : (row.BALANCE | number:'1.3-3') }}
                    </td>
                    <!--<td class="text-end">{{ (row.BALANCE | abs) | number:'1.3-3' }} {{ row.BALANCE > 0 ? '(D)' : '(C)' }}</td> -->
                    <!--<td class="text-end">{{ row.DAYS_DIFF === null ? '-' : row.DAYS_DIFF + (row.DAYS_DIFF > 0 ? ' overdue' : ' left') }}</td>   -->                 
                </tr>
            </tbody>
            <tfoot>
                <tr class="fw-bold text-end">
                    <td colspan="5" class="text-start">Total</td>
                    <td>{{ totalDebit | number:'1.3-3' }}</td>
                    <td>{{ totalCredit | number:'1.3-3' }}</td>
                    <td>
                        {{ (totalDebit-totalCredit) < 0 ? '-' : '' }}
                        {{ ((totalDebit-totalCredit) | number:'1.3-3') }} 
                        {{ (totalDebit-totalCredit) > 0 ? '(D)' : (totalDebit-totalCredit) < 0 ? '(C)' : '' }}
                    </td>
                </tr>
            </tfoot>
        </table>
        <br>
        <table id="ageingSummaryTable" class="table table-sm table-bordered">
            <thead>
                <tr class="table-primary">
                    <th colspan="6" class="text-start">Ageing Summary</th>
                </tr>
                <tr class="text-end table-secondary">
                    <th>Current</th>
                    <th>0 - 30 days</th>
                    <th>31 - 60 days</th>
                    <th>61 - 90 days</th>
                    <th>91 - 120 days</th>
                    <th>Above 120 days</th>
                </tr>
            </thead>
            <tbody>
                <tr class="text-end">
                    <td>{{ ageingSummary['CURRENT'] | number:'1.3-3' }}</td>
                    <td>{{ ageingSummary['30_DAYS'] | number:'1.3-3' }}</td>
                    <td>{{ ageingSummary['60_DAYS'] | number:'1.3-3' }}</td>
                    <td>{{ ageingSummary['90_DAYS'] | number:'1.3-3' }}</td>
                    <td>{{ ageingSummary['120_DAYS'] | number:'1.3-3' }}</td>
                    <td>{{ ageingSummary['ABOVE_120_DAYS'] | number:'1.3-3' }}</td>
                </tr>
            </tbody>
        </table>
        <br>
        <table id="unallocPayTable" class="table table-sm table-bordered">
            <thead>
                <tr class="table-primary">
                    <th colspan="6" class="text-start">Unallocated Payments Summary</th>
                </tr>
                <tr class="text-end table-secondary">
                    <th>Future Remit</th>
                    <th>60 Days</th>
                    <th>120 Days</th>
                    <th>180 Days</th>
                    <th>365 Days</th>
                    <th>Above 365</th>
                </tr>
            </thead>
            <tbody>
                <tr class="text-end">
                    <td>{{ unallocPaySummary['FUTURE_REMIT'] | number:'1.3-3' }}</td>
                    <td>{{ unallocPaySummary['60_DAYS'] | number:'1.3-3' }}</td>
                    <td>{{ unallocPaySummary['120_DAYS'] | number:'1.3-3' }}</td>
                    <td>{{ unallocPaySummary['180_DAYS'] | number:'1.3-3' }}</td>
                    <td>{{ unallocPaySummary['365_DAYS'] | number:'1.3-3' }}</td>
                    <td>{{ unallocPaySummary['ABOVE_365_DAYS'] | number:'1.3-3' }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    <hr>
    <div class="row container-fluid">
        <div class="col-8"></div>
        <!---- <div class="col-3">
            <button mat-raised-button class="bg-primary text-white btn  " (click)="printCOA('S')" style="float: right" title="print">
                Print Statement Summary
            </button>
        </div>-->
        <div class="col-4">
            <button mat-raised-button class="bg-success text-white btn  " (click)="printCOA()" style="float: right" title="print">
                Print Statement Summary
            </button>
        </div>
    </div>
    <br>
</ng-template>
